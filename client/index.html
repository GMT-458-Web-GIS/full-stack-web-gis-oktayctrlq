<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Belediye CBS | Akƒ±llƒ± Kent Y√∂netim Paneli</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #0f172a;
            --secondary: #3b82f6;
            --accent: #f59e0b;
            --danger: #ef4444;
            --success: #10b981;
            --glass: rgba(255, 255, 255, 0.85);
            --bg: #f8fafc;
            --text: #1e293b;
        }

        body.dark-mode {
            --primary: #f8fafc;
            --secondary: #60a5fa;
            --glass: rgba(15, 23, 42, 0.9);
            --bg: #020617;
            --text: #f1f5f9;
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Loading Screen */
        #loader { position: fixed; inset: 0; background: #0f172a; z-index: 30000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.5s; }
        .spinner { width: 60px; height: 60px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--secondary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Landing Page Geli≈ütirilmi≈ü */
        #landing-page { 
            position: fixed; inset: 0; 
            background: radial-gradient(circle at top right, #1e3a8a, #0f172a); 
            color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; text-align: center;
        }
        .hero-title { font-size: 4.5rem; font-weight: 800; margin: 0; background: linear-gradient(to right, #fff, #93c5fd); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .role-cards { display: flex; gap: 25px; margin: 50px 0; }
        .card { 
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px); padding: 35px; border-radius: 24px; width: 220px;
            transition: 0.3s; cursor: default;
        }
        .card:hover { transform: translateY(-10px); background: rgba(255, 255, 255, 0.1); border-color: var(--secondary); }
        .card i { font-size: 2rem; display: block; margin-bottom: 15px; }

        /* Auth Container */
        #auth-container { display: none; position: fixed; inset: 0; background: rgba(2, 6, 23, 0.85); backdrop-filter: blur(8px); justify-content: center; align-items: center; z-index: 20000; }
        .auth-box { background: var(--glass); padding: 45px; border-radius: 32px; width: 380px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        .auth-box input, .auth-box select { width: 100%; padding: 15px; margin: 12px 0; border: 1px solid rgba(0,0,0,0.1); border-radius: 12px; font-size: 1rem; outline: none; transition: 0.3s; }
        .auth-box input:focus { border-color: var(--secondary); ring: 2px solid var(--secondary); }
        .auth-btn { width: 100%; padding: 16px; background: var(--secondary); color: white; border: none; border-radius: 14px; cursor: pointer; font-weight: 700; font-size: 1rem; margin-top: 10px; }

        /* Map UI */
        #map-container { display: none; height: 100%; width: 100%; position: relative; }
        #map { height: 100%; width: 100%; }

        .stats-panel { 
            position: absolute; top: 25px; left: 25px; z-index: 1000; 
            background: var(--glass); backdrop-filter: blur(12px); color: var(--primary);
            padding: 20px; border-radius: 20px; min-width: 240px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .controls {
            position: absolute; bottom: 35px; left: 50%; transform: translateX(-50%);
            background: var(--glass); backdrop-filter: blur(16px); padding: 20px 30px; 
            border-radius: 28px; z-index: 1000; display: flex; gap: 15px; align-items: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-action { padding: 12px 24px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-save { background: var(--success); color: white; }
        .btn-save:hover { opacity: 0.9; transform: scale(1.05); }

        .top-nav { position: absolute; top: 25px; right: 25px; z-index: 1000; display: flex; gap: 15px; }
        .nav-btn { background: var(--glass); padding: 12px 20px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p style="color: white; margin-top: 20px; font-weight: 500; letter-spacing: 1px;">Sƒ∞STEM BA≈ûLATILIYOR...</p>
    </div>

    <div id="landing-page">
        <h1 class="hero-title">Belediye CBS</h1>
        <p style="font-size: 1.2rem; opacity: 0.8;">S√ºrd√ºr√ºlebilir ve Akƒ±llƒ± ≈ûehir Y√∂netim Altyapƒ±sƒ±</p>
        
        <div class="role-cards">
            <div class="card">
                <h3>Vatanda≈ü</h3>
                <p style="font-size: 0.8rem; opacity: 0.7;">Sorun bildir, ≈üehrini geli≈ütir ve taleplerini takip et.</p>
            </div>
            <div class="card">
                <h3>Belediye</h3>
                <p style="font-size: 0.8rem; opacity: 0.7;">Gelen talepleri analiz et, ekipleri hƒ±zlƒ±ca y√∂nlendir.</p>
            </div>
            <div class="card">
                <h3>Y√∂netici</h3>
                <p style="font-size: 0.8rem; opacity: 0.7;">T√ºm ≈üehir verisini izle, stratejik kararlar al.</p>
            </div>
        </div>

        <button onclick="enterSystem()" style="padding: 22px 70px; border-radius: 50px; background: var(--secondary); color:white; border: none; font-weight: 800; cursor: pointer; box-shadow: 0 15px 30px rgba(59, 130, 246, 0.4);">Sƒ∞STEME Gƒ∞Rƒ∞≈û YAP</button>
    </div>

    <div id="auth-container">
        <div class="auth-box">
            <h2 id="form-title" style="margin-bottom: 25px;">Y√∂netim Paneli</h2>
            <input type="text" id="username" placeholder="Kullanƒ±cƒ± Adƒ±">
            <input type="password" id="password" placeholder="≈ûifre">
            <select id="role-select" style="display:none;">
                <option value="Vatanda≈ü">Vatanda≈ü</option>
                <option value="Belediye">Belediye Birimi</option>
                <option value="admin">Sistem Y√∂neticisi</option>
            </select>
            <button class="auth-btn" id="auth-btn" onclick="handleLogin()">Gƒ∞Rƒ∞≈û YAP</button>
            <button onclick="toggleForm()" style="background:none; border:none; color:var(--secondary); margin-top:20px; cursor:pointer; font-weight:600;">Hesabƒ±nƒ±z yok mu? Kayƒ±t Olun</button>
        </div>
    </div>

    <div id="map-container">
        <div class="top-nav">
            <button class="nav-btn" onclick="toggleTheme()">üåì Tema</button>
            <button class="nav-btn" style="background:var(--danger); color:white;" onclick="logout()">√áƒ±kƒ±≈ü Yap</button>
        </div>
        
        <div class="stats-panel">
            <h4 style="margin:0 0 15px 0; color:var(--secondary);">üìä ≈ûehir ƒ∞statistikleri</h4>
            <div style="margin-bottom: 8px;">Oturum: <b id="user-role-display">...</b></div>
            <div>Toplam Rapor: <b id="total-count">0</b></div>
            <div style="margin-top:15px; height: 6px; background: rgba(0,0,0,0.05); border-radius: 10px; overflow:hidden;">
                <div id="progress-bar" style="height:100%; background:var(--secondary); width: 0%; transition: 1.5s;"></div>
            </div>
            <p style="font-size: 0.7rem; margin-top: 10px; color: #64748b;">* Haritaya tƒ±klayarak konum se√ßebilirsiniz.</p>
        </div>

        <div id="map"></div>

        <div class="controls">
            <input type="text" id="title" placeholder="Sorun Ba≈ülƒ±ƒüƒ±" style="width: 130px; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
            <input type="text" id="desc" placeholder="A√ßƒ±klama" style="width: 150px; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
            <input type="file" id="photo" style="font-size: 11px; width: 140px;">
            <button onclick="getLocation()" title="Konumumu Bul" style="background:#f1f5f9; border:none; padding:12px; border-radius:12px; cursor:pointer;">üìç</button>
            <button onclick="saveIssue()" class="btn-action btn-save">KAYDET</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script>
        const API_BASE_URL = "http://13.48.248.53:5002"; 
        let map, markersLayer, currentLat, currentLng, allIssues = [], isDarkMode = false, isRegisterMode = false, tempMarker;

        window.onload = () => { 
            setTimeout(() => { document.getElementById("loader").style.opacity = "0"; setTimeout(()=>document.getElementById("loader").style.display="none", 500); }, 1500); 
            if (localStorage.getItem("token")) showMap();
        };

        function enterSystem() { 
            document.getElementById("landing-page").style.display = "none"; 
            document.getElementById("auth-container").style.display = "flex"; 
        }

        function toggleForm() {
            isRegisterMode = !isRegisterMode;
            document.getElementById("form-title").innerText = isRegisterMode ? "Sisteme Kayƒ±t" : "Y√∂netim Paneli";
            document.getElementById("role-select").style.display = isRegisterMode ? "block" : "none";
            document.getElementById("auth-btn").innerText = isRegisterMode ? "KAYDI TAMAMLA" : "Gƒ∞Rƒ∞≈û YAP";
            document.getElementById("auth-btn").onclick = isRegisterMode ? handleRegister : handleLogin;
        }

        async function handleLogin() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/auth/login`, { 
                    method: "POST", headers: { "Content-Type": "application/json" }, 
                    body: JSON.stringify({ username: document.getElementById("username").value, password: document.getElementById("password").value })
                });
                const data = await res.json();
                if (res.ok) {
                    localStorage.setItem("token", data.token); 
                    localStorage.setItem("role", data.role); 
                    localStorage.setItem("username", data.username);
                    showMap();
                } else { alert("‚ùå " + data.error); }
            } catch (err) { alert("Sunucu hatasƒ±! AWS baƒülantƒ±sƒ±nƒ± kontrol edin."); }
        }

        async function handleRegister() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/auth/register`, { 
                    method: "POST", headers: { "Content-Type": "application/json" }, 
                    body: JSON.stringify({ username: document.getElementById("username").value, password: document.getElementById("password").value, role: document.getElementById("role-select").value })
                });
                if (res.ok) { alert("‚úÖ Kayƒ±t ba≈üarƒ±lƒ±! Giri≈ü yapabilirsiniz."); toggleForm(); } else { alert("‚ùå Kayƒ±t hatasƒ±."); }
            } catch (err) { alert("Baƒülantƒ± hatasƒ±!"); }
        }

        function showMap() {
            document.getElementById("landing-page").style.display = "none";
            document.getElementById("auth-container").style.display = "none";
            document.getElementById("map-container").style.display = "block";
            document.getElementById("user-role-display").innerText = localStorage.getItem("role");
            if (!map) {
                map = L.map('map', { zoomControl: false }).setView([39.93, 32.85], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
                markersLayer = L.markerClusterGroup(); 
                map.addLayer(markersLayer);

                // HARƒ∞TAYA TIKLAYINCA KONUM SE√áME √ñZELLƒ∞ƒûƒ∞
                map.on('click', function(e) {
                    currentLat = e.latlng.lat;
                    currentLng = e.latlng.lng;
                    if (tempMarker) map.removeLayer(tempMarker);
                    tempMarker = L.marker([currentLat, currentLng], {draggable: true}).addTo(map)
                        .bindPopup("<b>Se√ßilen Konum</b><br>Kaydet butonuna basabilirsiniz.").openPopup();
                });

                loadIssues();
            }
        }

        async function loadIssues() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/issues`);
                allIssues = await res.json();
                renderMarkers();
                document.getElementById("progress-bar").style.width = Math.min(allIssues.length * 5, 100) + "%";
            } catch (err) { console.error("Veriler √ßekilemedi:", err); }
        }

        function renderMarkers() {
            markersLayer.clearLayers();
            const role = localStorage.getItem("role");
            const user = localStorage.getItem("username");
            allIssues.forEach(issue => {
                // Rol bazlƒ± filtreleme: Vatanda≈ü sadece kendi kaydƒ±nƒ± g√∂r√ºr, admin hepsini.
                if (role === "Vatanda≈ü" && issue.created_by !== user) return;
                
                if (issue.lat && issue.lng) {
                    const marker = L.circleMarker([issue.lat, issue.lng], { 
                        radius: 12, fillColor: "#3b82f6", color: "white", weight: 3, fillOpacity: 0.9 
                    });
                    let content = `<div style="min-width:180px;"><b>üìç ${issue.title}</b><p style="font-size:0.85rem;">${issue.description}</p>`;
                    if (issue.photo) {
                        content += `<img src="${API_BASE_URL}/uploads/${issue.photo}" width="100%" style="border-radius:12px; margin-top:8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">`;
                    }
                    content += `<div style="font-size:0.7rem; color:#94a3b8; margin-top:8px;">Bildiren: ${issue.created_by}</div></div>`;
                    marker.addTo(markersLayer).bindPopup(content);
                }
            });
            document.getElementById("total-count").innerText = allIssues.length;
        }

        function getLocation() {
            navigator.geolocation.getCurrentPosition(pos => {
                currentLat = pos.coords.latitude; currentLng = pos.coords.longitude;
                map.flyTo([currentLat, currentLng], 17);
                if (tempMarker) map.removeLayer(tempMarker);
                tempMarker = L.marker([currentLat, currentLng]).addTo(map).bindPopup("üìç Mevcut Konumunuz").openPopup();
            }, err => alert("Konum eri≈üimi reddedildi. Haritaya tƒ±klayarak konum se√ßebilirsiniz."));
        }

        async function saveIssue() {
            if (!currentLat || !currentLng) return alert("L√ºtfen haritaya tƒ±klayarak veya GPS ile konum se√ßin!");
            const title = document.getElementById("title").value;
            if (!title) return alert("L√ºtfen bir ba≈ülƒ±k girin!");

            const formData = new FormData();
            formData.append("title", title);
            formData.append("description", document.getElementById("desc").value);
            formData.append("latitude", currentLat); 
            formData.append("longitude", currentLng);
            const photoFile = document.getElementById("photo").files[0];
            if (photoFile) formData.append("photo", photoFile);

            try {
                const res = await fetch(`${API_BASE_URL}/api/issues`, { 
                    method: "POST", 
                    headers: { "x-auth-token": localStorage.getItem("token") }, 
                    body: formData 
                });

                if (res.ok) { 
                    alert("‚úÖ Kayƒ±t ba≈üarƒ±yla sisteme iletildi!"); 
                    if (tempMarker) map.removeLayer(tempMarker);
                    document.getElementById("title").value = "";
                    document.getElementById("desc").value = "";
                    document.getElementById("photo").value = "";
                    loadIssues(); 
                } else {
                    const data = await res.json();
                    alert("‚ùå Hata: " + data.error);
                }
            } catch (err) { alert("‚ùå Sunucuya baƒülanƒ±lamadƒ±!"); }
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle("dark-mode");
            const theme = isDarkMode ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
            if(map) L.tileLayer(theme).addTo(map);
        }

        function logout() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>