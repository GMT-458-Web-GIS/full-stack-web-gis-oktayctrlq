<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Belediye CBS | AkÄ±llÄ± Kent Paneli</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #1e3c72; --secondary: #2a5298; --accent: #ffc107;
            --danger: #dc3545; --success: #28a745; --glass: rgba(255, 255, 255, 0.9);
            --bg: #f4f7f6; --text: #333;
        }

        body.dark-mode {
            --primary: #0f172a; --secondary: #1e293b; --glass: rgba(30, 41, 59, 0.95);
            --bg: #020617; --text: #f8fafc;
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); transition: 0.3s; }
        
        /* Loading Animasyonu */
        #loader { position: fixed; inset: 0; background: var(--primary); z-index: 20000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1); border-top: 5px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* KarÅŸÄ±lama EkranÄ± */
        #landing-page { position: fixed; inset: 0; background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; }
        .card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px); padding: 30px; border-radius: 20px; width: 220px; border: 1px solid rgba(255,255,255,0.2); text-align: center; }

        /* GiriÅŸ Paneli */
        #auth-container { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 9999; }
        .auth-box { background: white; padding: 40px; border-radius: 24px; width: 350px; text-align: center; color: #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .auth-box input, .auth-box select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        .auth-box button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; }

        /* Harita ve Paneller */
        #map-container { display: none; height: 100%; width: 100%; position: relative; }
        #map { height: 100%; width: 100%; }

        .controls {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: var(--glass); backdrop-filter: blur(12px); padding: 15px 25px; 
            border-radius: 24px; z-index: 1000; display: flex; gap: 12px; align-items: center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }

        .stats-panel { position: absolute; top: 25px; left: 25px; z-index: 1000; background: var(--primary); color: white; padding: 20px; border-radius: 18px; min-width: 220px; }
        .theme-toggle { position: absolute; top: 25px; right: 150px; z-index: 1000; background: var(--accent); border: none; padding: 12px; border-radius: 12px; cursor: pointer; font-weight: bold; }
        .logout-btn { position: absolute; top: 25px; right: 25px; z-index: 1000; background: var(--danger); color: white; padding: 12px 20px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p style="color: white; margin-top: 15px; font-weight: 600;">Sistem YÃ¼kleniyor...</p>
    </div>

    <div id="landing-page">
        <h1 style="font-size: 3.5rem; margin-bottom: 10px;">Belediye CBS</h1>
        <p style="opacity: 0.9; margin-bottom: 40px;">AkÄ±llÄ± Åehir YÃ¶netim Sistemi</p>
        <div style="display: flex; gap: 20px;">
            <div class="card"><h3>ğŸ‘¤ VatandaÅŸ</h3></div>
            <div class="card"><h3>ğŸ›¡ï¸ YÃ¶netici</h3></div>
        </div>
        <button onclick="enterSystem()" style="margin-top: 40px; padding: 20px 60px; border-radius: 50px; background: var(--accent); border: none; font-weight: 800; cursor: pointer;">KEÅFETMEYE BAÅLA ğŸš€</button>
    </div>

    <div id="auth-container">
        <div class="auth-box">
            <h2 id="form-title">GiriÅŸ Yap</h2>
            <input type="text" id="username" placeholder="KullanÄ±cÄ± AdÄ±">
            <input type="password" id="password" placeholder="Åifre">
            <select id="role-select" style="display:none;">
                <option value="VatandaÅŸ">VatandaÅŸ</option>
                <option value="Belediye">Belediye</option>
                <option value="admin">YÃ¶netici</option>
            </select>
            <button id="auth-btn" onclick="handleLogin()">Devam Et</button>
            <button onclick="toggleForm()" style="background:none; border:none; color:#666; margin-top:15px; cursor:pointer; text-decoration:underline;">KayÄ±t Ol</button>
        </div>
    </div>

    <div id="map-container">
        <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™ Mod DeÄŸiÅŸtir</button>
        <button class="logout-btn" onclick="logout()">GÃ¼venli Ã‡Ä±kÄ±ÅŸ</button>
        
        <div class="stats-panel">
            <h4 style="margin:0 0 15px 0; color:var(--accent);">ğŸ“Š Sistem Ã–zeti</h4>
            <div>Rol: <b id="user-role-display">...</b></div>
            <div>KayÄ±t SayÄ±sÄ±: <b id="total-count">0</b></div>
            <div style="margin-top:10px; height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow:hidden;">
                <div id="progress-bar" style="height:100%; background:var(--success); width: 0%; transition: 1s;"></div>
            </div>
        </div>

        <div id="map"></div>

        <div class="controls">
            <input type="text" id="search-input" placeholder="ğŸ” Ara..." style="width: 100px; padding: 8px; border-radius: 8px;">
            <button onclick="searchAndFocus()" style="background:var(--primary); color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer;">GÄ°T</button>
            <div style="width:1px; height:30px; background:#ddd; margin:0 5px;"></div>
            <input type="text" id="title" placeholder="BaÅŸlÄ±k" style="width: 100px;">
            <input type="text" id="desc" placeholder="AÃ§Ä±klama" style="width: 100px;">
            <input type="file" id="photo" style="font-size: 10px; width: 120px;">
            <button onclick="getLocation()" style="background:#17a2b8; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer;">ğŸ“</button>
            <button onclick="saveIssue()" style="background:var(--success); color:white; border:none; padding:10px 20px; border-radius:8px; font-weight:700; cursor:pointer;">KAYDET</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script>
        let map, markersLayer, currentLat, currentLng, allIssues = [], isDarkMode = false, isRegisterMode = false;

        window.onload = () => { 
            setTimeout(() => { document.getElementById("loader").style.display = "none"; }, 1500); 
            if (localStorage.getItem("token")) showMap();
        };

        function enterSystem() { 
            document.getElementById("landing-page").style.display = "none"; 
            document.getElementById("auth-container").style.display = "flex"; 
        }

        function toggleForm() {
            isRegisterMode = !isRegisterMode;
            document.getElementById("form-title").innerText = isRegisterMode ? "Yeni KayÄ±t" : "GiriÅŸ Yap";
            document.getElementById("role-select").style.display = isRegisterMode ? "block" : "none";
            document.getElementById("auth-btn").onclick = isRegisterMode ? handleRegister : handleLogin;
        }

        async function handleLogin() {
            try {
                const res = await fetch("/api/auth/login", { 
                    method: "POST", headers: { "Content-Type": "application/json" }, 
                    body: JSON.stringify({ username: document.getElementById("username").value, password: document.getElementById("password").value })
                });
                const data = await res.json();
                if (res.ok) {
                    localStorage.setItem("token", data.token); 
                    localStorage.setItem("role", data.role); 
                    localStorage.setItem("username", data.username);
                    showMap();
                } else { alert("âŒ " + data.error); }
            } catch (err) { alert("Sunucu hatasÄ±!"); }
        }

        async function handleRegister() {
            try {
                const res = await fetch("/api/auth/register", { 
                    method: "POST", headers: { "Content-Type": "application/json" }, 
                    body: JSON.stringify({ username: document.getElementById("username").value, password: document.getElementById("password").value, role: document.getElementById("role-select").value })
                });
                if (res.ok) { alert("âœ… KayÄ±t baÅŸarÄ±lÄ±! GiriÅŸ yapabilirsiniz."); toggleForm(); } else { alert("âŒ KayÄ±t hatasÄ±."); }
            } catch (err) { alert("BaÄŸlantÄ± hatasÄ±!"); }
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle("dark-mode");
            const theme = isDarkMode ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
            if(map) L.tileLayer(theme).addTo(map);
        }

        function showMap() {
            document.getElementById("landing-page").style.display = "none";
            document.getElementById("auth-container").style.display = "none";
            document.getElementById("map-container").style.display = "block";
            document.getElementById("user-role-display").innerText = localStorage.getItem("role");
            if (!map) {
                map = L.map('map', { zoomControl: false }).setView([39.93, 32.85], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
                markersLayer = L.markerClusterGroup(); map.addLayer(markersLayer);
                loadIssues();
            }
        }

        async function loadIssues() {
            const res = await fetch("/api/issues");
            allIssues = await res.json();
            renderMarkers();
            document.getElementById("progress-bar").style.width = Math.min(allIssues.length * 10, 100) + "%";
        }

        function renderMarkers() {
            markersLayer.clearLayers();
            const role = localStorage.getItem("role");
            const user = localStorage.getItem("username");
            allIssues.forEach(issue => {
                // Sadece kendi kayÄ±tlarÄ±nÄ± gÃ¶rme kÄ±sÄ±tlamasÄ± (VatandaÅŸ iÃ§in)
                if (role === "VatandaÅŸ" && issue.created_by !== user) return;
                
                if (issue.lat && issue.lng) {
                    const color = issue.title.toLowerCase().includes("acil") ? "red" : "#2a5298";
                    const marker = L.circleMarker([issue.lat, issue.lng], { radius: 10, fillColor: color, color: "white", weight: 2, fillOpacity: 0.8 });
                    let content = `<b>${issue.title}</b><p>${issue.description}</p>`;
                    if (issue.photo) content += `<img src="${issue.photo}" width="150" style="border-radius:10px; margin-top:5px;">`;
                    marker.addTo(markersLayer).bindPopup(content);
                }
            });
            document.getElementById("total-count").innerText = allIssues.length;
        }

        function searchAndFocus() {
            const text = document.getElementById("search-input").value.toLowerCase();
            const found = allIssues.find(i => (i.title + i.description).toLowerCase().includes(text));
            if (found) map.flyTo([found.lat, found.lng], 18);
        }

        function getLocation() {
            navigator.geolocation.getCurrentPosition(pos => {
                currentLat = pos.coords.latitude; currentLng = pos.coords.longitude;
                map.flyTo([currentLat, currentLng], 17);
                L.marker([currentLat, currentLng]).addTo(map).bindPopup("ğŸ“ BuradasÄ±nÄ±z").openPopup();
            }, err => alert("Konum alÄ±namadÄ±. LÃ¼tfen tarayÄ±cÄ± izinlerini kontrol edin."));
        }

        // GÃ¼ncellenmiÅŸ SaveIssue Fonksiyonu
        async function saveIssue() {
            if (!currentLat || !currentLng) return alert("LÃ¼tfen Ã¶nce konumunuzu belirleyin! (ğŸ“)");
            
            const title = document.getElementById("title").value;
            if (!title) return alert("LÃ¼tfen bir baÅŸlÄ±k girin!");

            const formData = new FormData();
            formData.append("title", title);
            formData.append("description", document.getElementById("desc").value);
            formData.append("latitude", currentLat); 
            formData.append("longitude", currentLng);
            
            const photoFile = document.getElementById("photo").files[0];
            if (photoFile) formData.append("photo", photoFile);

            try {
                const res = await fetch("/api/issues", { 
                    method: "POST", 
                    headers: { "x-auth-token": localStorage.getItem("token") }, 
                    body: formData 
                });

                if (res.ok) { 
                    alert("âœ… BaÅŸarÄ±yla kaydedildi!"); 
                    // Temizlik
                    document.getElementById("title").value = "";
                    document.getElementById("desc").value = "";
                    document.getElementById("photo").value = "";
                    loadIssues(); 
                } else {
                    const data = await res.json();
                    alert("âŒ Hata: " + (data.error || "Sunucu hatasÄ±"));
                }
            } catch (err) {
                alert("âŒ Sunucuya baÄŸlanÄ±lamadÄ±! Terminale bak.");
            }
        }

        function logout() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>